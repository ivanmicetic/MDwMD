<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add New Evidence</title>
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<link href="/css/styles.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
</head>
<body>
<div class="header">
  <nav class="navbar">
    <a class="navbar-item" href="/">Browse</a>
    <a class="navbar-item navbar-selected" href="/new_experiment">New experiment</a>
    <a class="navbar-item" href="/new_protein">New protein</a>
  </nav>
  <div id="signInDiv" class="ml-auto pr-2"></div>
</div>

<div class="container form-block">
  <h2 class="mt-2">Add New Experiment</h2>
  <p><span class="required-asterisk">*</span> required fields.</p>
  <form>

    <!-- PubMed ID, Reference Type -->
    <div class="form-row align-items-center mb-2">
      <div class="col-5">
        <label for="referenceId" class="form-label">PubMed ID (alt. DOI)<span class="required-asterisk">*</span></label>
        <div class="input-group">
          <input type="text" class="form-control" id="referenceId" placeholder="PubMed ID" value="">
          <div class="input-group-append">
            <button type="button" id="pubmedLink" class="btn btn-primary btn-square d-none">→</button>
          </div>
        </div>
      </div>
      <div class="col-2 d-flex flex-column align-items-start mt-5 pr-3 pl-1">
        <input type="checkbox" id="doiCheckbox" aria-label="Checkbox for DOI">
        <label for="doiCheckbox">DOI</label>
      </div>      
      <div class="col-5">
        <label for="referenceType" class="form-label">Reference Type</label>
        <select class="form-control" id="referenceType">
          <option value="" selected>Choose...</option>
          <option value="primary">Main reference (experiment)</option>
          <option value="secondary">Secondary reference (tables, lists or citations)</option>
          <option value="surrogate_primary">Best Available Reference (secondary but main is unreachable)</option>
        </select>
      </div> 
    </div>

    <!-- Protein Name, Species, Accession Number -->
    <div class="form-row align-items-center mb-2">
      <div class="col">
        <label for="proteinName" class="form-label">Protein Name<span class="required-asterisk">*</span></label>
        <input type="text" class="form-control" id="proteinName" placeholder="Protein Name" value="">
      </div>
      <div class="col">
        <label for="species" class="form-label">Species (Taxon ID)<span class="required-asterisk">*</span></label>
        <div class="input-group">
          <input type="text" class="form-control" id="species" placeholder="Species" value="">
          <div class="input-group-append">
            <button type="button" id="speciesLink" class="btn btn-primary btn-square d-none">→</button>
          </div>
        </div>
      </div>
      <div class="col">
        <label for="accessionNumber" class="form-label">Accession Number<span class="required-asterisk">*</span></label>
        <div class="input-group">
          <input type="text" class="form-control" id="accessionNumber" placeholder="Accession Number" value="">
          <div class="input-group-append">
            <button type="button" id="accessionLink" class="btn btn-primary btn-square d-none">→</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Diffusion Coefficient, Error, Unit -->
    <div class="form-row align-items-center mb-2">
      <div class="col">
        <label for="diffusionCoefficient" class="form-label">Diffusion Coefficient <span class="required-asterisk">*</span></label>
        <input type="number" class="form-control" id="diffusionCoefficient" placeholder="Coefficient" value="">
      </div>
      <div class="col">
        <label for="diffusionError" class="form-label">Error</label>
        <input type="number" class="form-control" id="diffusionError" placeholder="Error" value="">
      </div>
      <div class="col">
        <label for="diffusionUnit" class="form-label">Unit<span class="required-asterisk">*</span></label>
        <select class="form-control" id="diffusionUnit">
          <option value="" selected>Choose...</option>
          <option value="um2/s">um²/s</option>
          <option value="1e-7 cm2/s">10^(-7) cm²/s</option>
        </select>
      </div>
    </div>

    <!-- Manual Processing -->
    <div class="form-group mb-2">
        <div class="custom-control custom-checkbox">
          <input type="checkbox" class="custom-control-input" id="manualEstimationCheckbox">
          <label class="custom-control-label" for="manualEstimationCheckbox">Manual estimation</label>
        </div>
        <select class="form-control d-none" id="manualProcessing">
        <option value="" selected>Choose...</option>
        <option value="visual">Visual approximation (from plots)</option>
        <option value="calculations">Data inference (integration, calculations, etc.)</option>
        <option value="Other">Other</option>
        </select>
    </div>
    <div class="form-group mb-2 d-none" id="otherManualProcessingContainer">
        <label for="otherManualProcessing" class="form-label">Specify Manual Processing</label>
        <input type="text" class="form-control" id="otherManualProcessing" placeholder="Please specify" value="">
    </div>
    
    <!-- Method -->
    <div class="form-group mb-2">
        <label for="method" class="form-label">Method<span class="required-asterisk">*</span></label>
        <select class="form-control" id="method">
        <option value="" selected>Choose...</option>
        <option value="DLS">Dynamic Light Scattering (DLS) - Photon Correlation Spectroscopy (PCS)</option>
        <option value="FCS">Fluorescence Correlation Spectroscopy (FCS)</option>
        <option value="PFG-NMR">Pulse Field Gradient NMR (PFG-NMR)</option>
        <option value="Unknown">Not informed</option>
        <option value="Other">Other</option>
        </select>
    </div>
    <div class="form-group mb-2 d-none" id="otherMethodContainer">
        <label for="otherMethod" class="form-label">Specify Method</label>
        <input type="text" class="form-control" id="otherMethod" placeholder="Please specify" value="">
    </div>

    <!-- Extra data -->
    <div class="form-group mb-2">
      <label for="comment" class="form-label">Additional comments</label>
      <input type="text" class="form-control" id="comment" placeholder="Please specify..." value="">
    </div>

    <!-- Replaces another entry --> 
    <div class="form-group mb-2">
      <div class="custom-control custom-checkbox">
        <input type="checkbox" class="custom-control-input" id="replaceEntryCheckbox">
        <label class="custom-control-label" for="replaceEntryCheckbox">Replace and entry</label>
      </div>
      <input type="text" class="form-control d-none" id="replacedEntry" placeholder="Entry ID..." value="">
    </div>

    <!-- Submit button -->
    <div class="form-group text-center">
        <button type="button" id="submitBtn" class="btn btn-primary btn-lg">Submit</button>
    </div>
    

  </form>

  <!-- Links banner -->
  <div class="useful-links mt-4 mb-2 text-center">
    <h3>Useful Links</h3>
    <div class="d-flex justify-content-center">
      <a href="https://www.uniprot.org/" class="btn btn-uniprot" target="_blank">Uniprot</a>
      <a href="https://www.uniprot.org/taxonomy/" class="btn btn-taxonomy" target="_blank">Uniprot Taxonomy</a>
      <a href="https://pubmed.ncbi.nlm.nih.gov/" class="btn btn-pubmed" target="_blank">PubMed</a>      
    </div>
  </div>

</div>

<script>
  document.addEventListener('DOMContentLoaded', async() => {
      const { showToast, clearFormFields, displayUserAlias, getUserId } = await import('./js/utils.js');

      // Configurations
      $('#submissionToast').toast({ delay: 3000 }); // Autohide after 3000ms
      displayUserAlias('signInDiv');

      // Function to show or hide 'Other' input fields based on dropdown selection
      function handleOtherInputFields() {
          $('#manualProcessing').change(function() {
              if ($(this).val() === 'Other') {
                  $('#otherManualProcessingContainer').removeClass('d-none');
              } else {
                  $('#otherManualProcessingContainer').addClass('d-none');
              }
          });
          $('#method').change(function() {
              if ($(this).val() === 'Other') {
                  $('#otherMethodContainer').removeClass('d-none');
              } else {
                  $('#otherMethodContainer').addClass('d-none');
              }
          });
          // Initialize dynamic link buttons
          initDynamicLinks();
      }
  
      // Initialize event listeners for dynamic link buttons
      function initDynamicLinks() {
          $('#accessionNumber').on('input', function() {
              const val = $(this).val();
              const btn = $('#accessionLink');
              btn.toggleClass('d-none', !val); // Show button if value is not empty
              if (val) {
                  btn.attr('onclick', `window.open('https://www.uniprot.org/uniprotkb/${val}/entry', '_blank')`);
              }
          });
  
          $('#species').on('input', function() {
              const val = $(this).val();
              const btn = $('#speciesLink');
              btn.toggleClass('d-none', !val); // Show button if value is not empty
              if (val) {
                  btn.attr('onclick', `window.open('https://www.uniprot.org/taxonomy/${val}', '_blank')`);
              }
          });
  
          $('#referenceId').on('input', function() {
              const val = $(this).val();
              const btn = $('#pubmedLink');
              btn.toggleClass('d-none', !val); // Show button if value is not empty
              if (val) {
                  btn.attr('onclick', `window.open('https://pubmed.ncbi.nlm.nih.gov/${val}/', '_blank')`);
              }
          });
      }
  
      function submitForm() {

          const isDoi = document.getElementById('doiCheckbox').checked;

          const formData = {
            diffusionCoefficient: document.getElementById('diffusionCoefficient').value || null,
            diffusionError: document.getElementById('diffusionError').value || null,
            diffusionUnit: document.getElementById('diffusionUnit').value || null,
            manualProcessing: document.getElementById('manualProcessing').value || null,
            otherManualProcessing: document.getElementById('otherManualProcessing').value || null,
            method: document.getElementById('method').value || null,
            otherMethod: document.getElementById('otherMethod').value || null,
            proteinName: document.getElementById('proteinName').value || null,
            species: document.getElementById('species').value || null,
            accessionNumber: document.getElementById('accessionNumber').value || null,
            referenceId: document.getElementById('referenceId').value || null,
            referenceIdType: isDoi ? 'doi' : 'pmid',
            referenceType: document.getElementById('referenceType').value || null,
            comment: document.getElementById('comment').value || null,
            userId: getUserId()
          };

          // Entry that is replaced by this one, in POST is a separate field
          const replacedEntry = document.getElementById('replacedEntry').value || null


          // Check if mandatory fields are filled
          const mandatoryFields = ['diffusionCoefficient', 'diffusionUnit', 'method', 'proteinName', 'species', 'accessionNumber', 'referenceId', 'userId'];

          for (let field of mandatoryFields) {
              if (!formData[field]) {
                showToast('Error', `Missing field: ${field}`, 'red');
                return;
              }
          }
  
          // Send data to server
          fetch('/api/experiment', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                data:formData,
                replacedEntry
              }),
          })
          .then(response => {
              if (!response.ok) {
                    showToast('Error', 'Network response was not ok', 'red');
                    throw new Error('Network response was not ok');
              }
              showToast('Success', `Submitted ${formData.proteinName}`, 'green');
              clearFormFields();
          })
          .catch((error) => {
              console.error('Error:', error);
          });
      }
  
      $('#submitBtn').on('click', function(e) {
          e.preventDefault();
          submitForm();
      });
  
      handleOtherInputFields(); // Initialize the function to handle 'Other' input fields

      function toggleManualProcessingVisibility() {
        $('#manualEstimationCheckbox').change(function() {
            if ($(this).is(':checked')) {
                $('#manualProcessing').removeClass('d-none');
            } else {
                $('#manualProcessing').addClass('d-none');
            }
        });
      }

      toggleManualProcessingVisibility();

      function toggleReplaceEntryVisibility() {
        $('#replaceEntryCheckbox').change(function() {
            if ($(this).is(':checked')) {
                $('#replacedEntry').removeClass('d-none');
            } else {
                $('#replacedEntry').addClass('d-none');
            }
        });
      }

      toggleReplaceEntryVisibility();

  });
</script>
  
</body>
</html>
