<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add New Evidence</title>
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<link href="/css/styles.css" rel="stylesheet">
</head>
<body>
<!-- Header -->
<div class="header">
    <nav class="navbar">
        <a class="navbar-item" href="/">Browse Experiments</a>
        <a class="navbar-item" href="/browse-proteins">Browse Proteins</a>
        <a class="navbar-item navbar-selected " href="/new_experiment">New experiment</a>
        <a class="navbar-item" href="/new_protein">New protein</a>
    </nav>
    <div id="signInDiv" class="ml-auto pr-2"></div>
</div>

<div class="container form-block">
    <!-- Title -->
    <h2 class="mt-2">Update Existing Experiment</h2>
    <p><span class="required-asterisk">*</span> required fields.</p>
    <form id="mainForm">

        <!-- Reference section -->
        <div class="form-row align-items-center mb-2">
        <div class="col-5">
            <label for="referenceId" class="form-label">PubMed ID (alt. DOI)<span class="required-asterisk">*</span></label>
            <div class="input-group">
            <input type="text" class="form-control" id="referenceId" placeholder="PubMed ID" value="">
            <div class="input-group-append">
                <button type="button" id="pubmedLink" class="btn btn-primary btn-square d-none">→</button>
            </div>
            </div>
        </div>
        <div class="col-2 d-flex flex-column align-items-start mt-5 pr-3 pl-1">
            <input type="checkbox" id="doiCheckbox">
            <label for="doiCheckbox">DOI</label>
        </div>      
        <div class="col-5">
            <label for="referenceType" class="form-label">Reference Type</label>
            <select class="form-control" id="referenceType">
                <option value="" selected>Choose...</option>
                <option value="primary">Main reference (experiment)</option>
                <option value="secondary">Secondary reference (tables, lists or citations)</option>
                <option value="surrogate_primary">Best Available Reference (secondary but main is unreachable)</option>
            </select>
        </div> 
        </div>


        <!-- Protein Section -->
        <div class="form-row align-items-center mb-2">
        <div class="col">
            <label for="proteinName" class="form-label">Protein Name<span class="required-asterisk">*</span></label>
            <input type="text" class="form-control" id="proteinName" placeholder="Protein Name" value="">
        </div>
        <div class="col">
            <label for="species" class="form-label">Species (Taxon ID)<span class="required-asterisk">*</span></label>
            <div class="input-group">
            <input type="text" class="form-control" id="species" placeholder="Species" value="">
            <div class="input-group-append">
                <button type="button" id="speciesLink" class="btn btn-primary btn-square d-none">→</button>
            </div>
            </div>
        </div>
        <div class="col">
            <label for="accessionNumber" class="form-label">Accession Number<span class="required-asterisk">*</span></label>
            <div class="input-group">
            <input type="text" class="form-control" id="accessionNumber" placeholder="Accession Number" value="">
            <div class="input-group-append">
                <button type="button" id="accessionLink" class="btn btn-primary btn-square d-none">→</button>
            </div>
            </div>
        </div>
        </div>


        <!-- Diffusivity -->
        <div class="form-row align-items-center mb-2">
        <div class="col">
            <label for="diffusionCoefficient" class="form-label">Diffusion Coefficient <span class="required-asterisk">*</span></label>
            <input type="number" class="form-control" id="diffusionCoefficient" placeholder="Coefficient" value="">
        </div>
        <div class="col">
            <label for="diffusionError" class="form-label">Error</label>
            <input type="number" class="form-control" id="diffusionError" placeholder="Error" value="">
        </div>
        <div class="col">
            <label for="diffusionUnit" class="form-label">Unit<span class="required-asterisk">*</span></label>
            <select class="form-control" id="diffusionUnit">
            <option value="" selected>Choose...</option>
            <option value="um2/s">um²/s</option>
            <option value="1e-7 cm2/s">10^(-7) cm²/s</option>
            </select>
        </div>
        </div>


        <!-- Experiment -->
        <div class="form-group mb-2">
            <label for="method" class="form-label">Method<span class="required-asterisk">*</span></label>
            <select class="form-control" id="method">
                <option value="" selected>Choose...</option>
                <option value="DLS">Dynamic Light Scattering (DLS) - Photon Correlation Spectroscopy (PCS)</option>
                <option value="FCS">Fluorescence Correlation Spectroscopy (FCS)</option>
                <option value="PFG-NMR">Pulse Field Gradient NMR (PFG-NMR)</option>
                <option value="Unknown">Not informed</option>
                <option value="Other">Other</option>
            </select>
        </div>
        <div class="form-group mb-2 d-none" id="otherMethodContainer">
            <label for="otherMethod" class="form-label">Specify Method</label>
            <input type="text" class="form-control" id="otherMethod" placeholder="Please specify" value="">
        </div>


        <!-- Comments -->
        <div class="form-group mb-2">
        <label for="comment" class="form-label">Additional comments</label>
        <input type="text" class="form-control" id="comment" placeholder="Please specify..." value="">
        </div>


        <!-- Data Processing -->
        <div class="form-group mb-2">
            <div class="custom-control custom-checkbox">
            <input type="checkbox" class="custom-control-input" id="manualEstimationCheckbox">
            <label class="custom-control-label" for="manualEstimationCheckbox">Manual estimation</label>
            </div>
            <select class="form-control d-none" id="manualProcessing">
                <option value="" selected>Choose...</option>
                <option value="visual">Visual approximation (from plots)</option>
                <option value="calculations">Data inference (integration, calculations, etc.)</option>
                <option value="Other">Other</option>
            </select>
        </div>
        <div class="form-group mb-2 d-none" id="otherManualProcessingContainer">
            <label for="otherManualProcessing" class="form-label">Specify Manual Processing</label>
            <input type="text" class="form-control" id="otherManualProcessing" placeholder="Please specify" value="">
        </div>


        <!-- Entry replacement --> 
        <div class="form-group mb-2">
        <div class="custom-control custom-checkbox">
            <input type="checkbox" class="custom-control-input" id="replaceEntryCheckbox">
            <label class="custom-control-label" for="replaceEntryCheckbox">Replace and entry</label>
        </div>
        <input type="text" class="form-control d-none" id="replacedEntry" placeholder="Entry ID..." value="">
        </div>


        <!-- Submit button -->
        <div class="form-group text-center">
            <button type="button" id="submitBtn" class="btn btn-primary btn-lg">Update entry</button>
        </div>
        
    </form>

    <!-- Links -->
    <div class="useful-links mt-4 mb-2 text-center">
        <h3>Useful Links</h3>
        <div class="d-flex justify-content-center">
        <a href="https://www.uniprot.org/" class="btn btn-uniprot" target="_blank">Uniprot</a>
        <a href="https://www.uniprot.org/taxonomy/" class="btn btn-taxonomy" target="_blank">Uniprot Taxonomy</a>
        <a href="https://pubmed.ncbi.nlm.nih.gov/" class="btn btn-pubmed" target="_blank">PubMed</a>      
        </div>
    </div>

</div>
<footer class="footer bg-light py-3 mt-4 border-top">
    <div class="container text-center">
        <p class="mb-1">© 2024 Protein Diffusion Database. All rights reserved.</p>
        <div class="mb-1">
            <a href="/privacy" class="mr-3">Privacy Policy</a>
            <a href="/contact" class="mr-3">Contact Us</a>
        </div>
<!--    
        <div class="social-links">
            <a href="https://facebook.com" target="_blank" class="mr-2"><i class="fab fa-facebook-f"></i></a>
            <a href="https://twitter.com" target="_blank" class="mr-2"><i class="fab fa-twitter"></i></a>
            <a href="https://linkedin.com" target="_blank"><i class="fab fa-linkedin-in"></i></a>
        </div>
-->
    </div>
</footer> 
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script>
let experimentId;
document.addEventListener('DOMContentLoaded', async() => {
    const { PageUtils, UserUtils } = await import('./js/utils.js');

    // Check entry id
    const urlParams = new URLSearchParams(window.location.search);
    experimentId = urlParams.get('id');
    if (!experimentId) {
        alert('No experiment ID was provided.');
        return;
    }    

    // Configurations
    UserUtils.displayUserAlias('signInDiv');

    setDynamicLink('#accessionNumber', '#accessionLink', 'https://www.uniprot.org/uniprotkb/');
    setDynamicLink('#species', '#speciesLink', 'https://www.uniprot.org/taxonomy/');
    setDynamicLink('#referenceId', '#pubmedLink', 'https://pubmed.ncbi.nlm.nih.gov/');

    PageUtils.toggleVisibility('#method', '#otherMethodContainer', (e,r) => e.value === 'Other');
    PageUtils.toggleVisibility('#manualProcessing', '#otherManualProcessingContainer', (e,r) => e.value === 'Other');
    PageUtils.toggleVisibility('#replaceEntryCheckbox','#replacedEntry', (e,r) => e.checked);
    PageUtils.toggleVisibility('#manualEstimationCheckbox', '#manualProcessing', (e,r) => e.checked);


    // Events
    document.getElementById('submitBtn').addEventListener('click', function() {
        // Get form data
        const exclusionList = ['manualEstimationCheckbox', 'replaceEntryCheckbox', 'replacedEntry', 'doiCheckbox']
        const inputs = document.querySelectorAll(`#mainForm input, #mainForm select`); //PROBLEM HERE
        const formData = {};
        inputs.forEach(input => {
            if (!(exclusionList.includes(input.id))) formData[input.id] = input.value;
        });
        formData.userId = UserUtils.getUserId();
        formData.referenceIdType = document.getElementById('doiCheckbox').checked ? 'doi' : 'pmid';

        const replacedEntry = document.getElementById('replacedEntry').value || null // Entry that is replaced by this one, in POST is a separate field

        // Check mandatory fields
        const mandatoryFields = ['diffusionCoefficient', 'diffusionUnit', 'method', 'proteinName', 'species', 'accessionNumber', 'referenceId', 'userId'];
        for (let field of mandatoryFields) {
            if (!formData[field]) {
                PageUtils.showToast('Error', `Missing field: ${field}`, 'red');
                return;
            }
        }

        // Send data to server
        fetch('/api/experiment', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                data:formData,
                replacedEntry,
                id: experimentId
            }),
        })
        .then(response => {
            if (!response.ok) {
                PageUtils.showToast('Error', 'Network response was not ok', 'red');
                throw new Error('Network response was not ok');
            }
            PageUtils.showToast('Success', `Submitted ${formData.proteinName}`, 'green');
            PageUtils.clearFormFields();
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    });

    // Fetch data from server
    fetchDataFromServer(experimentId);

    // Helper functions
    function setDynamicLink(inputSelector, buttonSelector, url) {
        $(inputSelector).on('input', function() {
            const val = $(this).val();
            const btn = $(buttonSelector);
            btn.toggleClass('d-none', !val); // Show button if value is not empty
            if (val) {
                btn.attr('onclick', `window.open('${url}${val}', '_blank')`);
            }
        });
    }

});

function fetchDataFromServer(id){
    fetch(`/api/find-by-id/experiment/${id}`)
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
        const entry = data.payload;
        // Populate the form fields with the retrieved data
        $('#diffusionCoefficient').val(entry.diffusionCoefficient);
        $('#diffusionError').val(entry.diffusionError);
        $('#diffusionUnit').val(entry.diffusionUnit);
        $('#manualProcessing').val(entry.manualProcessing);
        $('#otherManualProcessing').val(entry.otherManualProcessing);
        $('#method').val(entry.method);
        $('#otherMethod').val(entry.otherMethod);
        $('#proteinName').val(entry.proteinName);
        $('#species').val(entry.species);
        $('#accessionNumber').val(entry.accessionNumber);
        $('#referenceId').val(entry.referenceId);
        $('#referenceIdType').val(entry.referenceIdType);
        $('#referenceType').val(entry.referenceType);
        $('#comment').val(entry.comment);
        $('#userName').val(entry.userName);

        // Handle checkbox states
        $('#manualEstimationCheckbox').prop('checked', !!entry.manualProcessing);
        $('#doiCheckbox').prop('checked', (entry.referenceIdType === 'doi'));

        // Show/hide fields based on checkbox states
        if ($('#manualEstimationCheckbox').is(':checked')) {
            $('#manualProcessing').removeClass('d-none');
        }
        if ($('#replaceEntryCheckbox').is(':checked')) {
            $('#replacedEntry').removeClass('d-none');
        }
        if ($('#manualProcessing').val() === 'Other') {
            $('#otherManualProcessingContainer').removeClass('d-none');
        }
        if ($('#method').val() === 'Other') {
            $('#otherMethodContainer').removeClass('d-none');
        }        

        // Add more form field assignments as needed
        } else {
        alert('Error fetching data from the server.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while fetching data from the server.');
    });
}

</script>
  
</body>
</html>
